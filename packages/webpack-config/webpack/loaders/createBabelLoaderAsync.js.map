{"version":3,"file":"createBabelLoaderAsync.js","sourceRoot":"","sources":["../../src/loaders/createBabelLoaderAsync.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\nimport chalk from 'chalk';\nimport getPathsAsync from '../utils/getPathsAsync';\nconst getModule = name => path.join('node_modules', name);\n\n// Only compile files from the react ecosystem.\nconst includeModulesThatContainPaths = [\n  getModule('react-native'),\n  getModule('react-navigation'),\n  getModule('expo'),\n  getModule('unimodules'),\n  getModule('@react'),\n  getModule('@expo'),\n  getModule('@unimodules'),\n  getModule('native-base'),\n];\n\nconst parsedPackageNames = [];\n// TODO: Bacon: Support internal packages. ex: react/fbjs\nfunction packageNameFromPath(inputPath: string): string {\n  const modules = inputPath.split('node_modules/');\n  const libAndFile = modules.pop();\n  if (libAndFile.charAt(0) === '@') {\n    const [org, lib] = libAndFile.split('/');\n    return org + '/' + lib;\n  } else {\n    return libAndFile.split('/').shift();\n  }\n}\n\nfunction logPackage(packageName: string) {\n  if (!parsedPackageNames.includes(packageName)) {\n    parsedPackageNames.push(packageName);\n    console.log(chalk.cyan('\\nCompiling module: ' + chalk.bold(packageName)));\n  }\n}\n\nasync function ensureRootAsync(possibleProjectRoot: string): Promise<string> {\n  if (typeof possibleProjectRoot === 'string') {\n    return path.resolve(possibleProjectRoot);\n  }\n  return (await getPathsAsync()).root;\n}\n/**\n * A complex babel loader which uses the project's `babel.config.js`\n * to resolve all of the Unimodules which are shipped as ES modules (early 2019).\n */\nexport default async function createBabelLoaderAsync({\n  /**\n   * The webpack mode: `\"production\" | \"development\"`\n   */\n  mode,\n  babelProjectRoot,\n  include = [],\n  verbose,\n  ...options\n} = {}) {\n  const ensuredProjectRoot = await ensureRootAsync(babelProjectRoot);\n  const modules = [...includeModulesThatContainPaths, ...include];\n  const customUse = options.use || {};\n  const customUseOptions = customUse.options || {};\n\n  const isProduction = mode === 'production';\n  return {\n    test: /\\.[jt]sx?$/,\n    // Can only clobber test\n    // Prevent clobbering the `include` and `use` values.\n    ...options,\n\n    include(inputPath) {\n      for (const possibleModule of modules) {\n        if (inputPath.includes(possibleModule)) {\n          if (verbose) {\n            const packageName = packageNameFromPath(inputPath);\n            logPackage(packageName);\n          }\n          return inputPath;\n        }\n      }\n      // Is inside the project and is not one of designated modules\n      if (!inputPath.includes('node_modules') && inputPath.includes(ensuredProjectRoot)) {\n        return inputPath;\n      }\n      return null;\n    },\n    use: {\n      ...customUse,\n      // AFAIK there is no reason to replace `babel-loader`.\n      loader: 'babel-loader',\n\n      options: {\n        // TODO: Bacon: Caching seems to break babel\n        cacheDirectory: false,\n        // Explicitly use babel.config.js instead of .babelrc\n        babelrc: false,\n        // Attempt to use local babel.config.js file for compiling project.\n        configFile: true,\n        // If no babel.config.js file exists, use babel-preset-expo.\n        presets: [require.resolve('babel-preset-expo')],\n        // Only clobber hard coded values.\n        ...(customUseOptions || {}),\n\n        root: ensuredProjectRoot,\n        // Cache babel files in production\n        cacheCompression: isProduction,\n        compact: isProduction,\n      },\n    },\n  };\n}\n"]}